<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Audio Crossfade Player</title>
<script src="https://unpkg.com/wavesurfer.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        background: #111;
        color: white;
        padding: 20px;
    }
    .controls {
        margin-top: 15px;
    }
    button, input[type="number"], input[type="range"] {
        padding: 8px;
        margin-right: 10px;
        margin-top: 10px;
    }
    #playlist {
        margin-top: 20px;
    }
</style>
</head>
<body>

<h2>Audio Crossfade Player</h2>

<!-- AUDIO-ONLY UPLOADS -->
<input type="file" id="fileInput" accept="audio/*" multiple>

<div id="waveform" style="width:100%; height:120px; margin-top:20px;"></div>

<div class="controls">
    <button id="playPause">Play</button>

    <label>Crossfade (sec):</label>
    <input id="crossfade" type="number" min="0" step="0.1" value="2">

    <label>Volume:</label>
    <input id="volumeSlider" type="range" min="0" max="1" step="0.01" value="1">
    <button id="muteBtn">Mute</button>

    <label style="margin-left:20px;">
        <input type="checkbox" id="autoNext">
        Auto-fade into next song
    </label>
</div>

<h3>Playlist</h3>
<ol id="playlist"></ol>

<script>
/* -------------------------------
   DATA + WAVESURFER SETUP
-------------------------------- */
let wavesurfer = WaveSurfer.create({
    container: '#waveform',
    waveColor: "#999",
    progressColor: "#fff",
    responsive: true,
    height: 120
});

let playlist = [];
let currentIndex = 0;
let isMuted = false;
let previousVolume = 1;

/* -------------------------------
   LOAD AUDIO
-------------------------------- */
const fileInput = document.getElementById("fileInput");

fileInput.addEventListener("change", async (e) => {
    playlist = [];
    currentIndex = 0;

    for (let file of e.target.files) {
        playlist.push({
            name: file.name,
            file: URL.createObjectURL(file)
        });
    }

    renderPlaylist();
    loadTrack(0);
});

/* -------------------------------
   RENDER PLAYLIST
-------------------------------- */
function renderPlaylist() {
    let list = document.getElementById("playlist");
    list.innerHTML = "";

    playlist.forEach((track, i) => {
        let li = document.createElement("li");
        li.textContent = track.name;
        li.style.cursor = "pointer";
        li.onclick = () => loadTrack(i);
        list.appendChild(li);
    });
}

/* -------------------------------
   LOAD TRACK
-------------------------------- */
function loadTrack(i) {
    currentIndex = i;
    wavesurfer.load(playlist[i].file);
}

/* -------------------------------
   PLAY / PAUSE
-------------------------------- */
document.getElementById("playPause").onclick = () => {
    wavesurfer.playPause();
};

/* -------------------------------
   VOLUME + MUTE
-------------------------------- */
const volumeSlider = document.getElementById("volumeSlider");
const muteBtn = document.getElementById("muteBtn");

volumeSlider.oninput = () => {
    wavesurfer.setVolume(volumeSlider.value);
    if (volumeSlider.value > 0) {
        previousVolume = volumeSlider.value;
        isMuted = false;
        muteBtn.textContent = "Mute";
    }
};

muteBtn.onclick = () => {
    if (!isMuted) {
        previousVolume = volumeSlider.value;
        wavesurfer.setVolume(0);
        volumeSlider.value = 0;
        muteBtn.textContent = "Unmute";
        isMuted = true;
    } else {
        wavesurfer.setVolume(previousVolume);
        volumeSlider.value = previousVolume;
        muteBtn.textContent = "Mute";
        isMuted = false;
    }
};

/* -------------------------------
   DJ-STYLE OVERLAP CROSSFADE
-------------------------------- */
function fadeVolume(ws, from, to, duration) {
    let steps = 30;
    let stepTime = duration * 1000 / steps;
    let step = 0;

    let interval = setInterval(() => {
        step++;
        let vol = from + (to - from) * (step / steps);
        ws.setVolume(vol);
        if (step >= steps) clearInterval(interval);
    }, stepTime);
}

function playNextWithCrossfade() {
    let fadeDur = parseFloat(document.getElementById("crossfade").value);

    let nextIndex = (currentIndex + 1) % playlist.length;

    let nextWS = WaveSurfer.create({
        container: document.createElement("div"),
        waveColor: "transparent",
        progressColor: "transparent",
        height: 0
    });

    nextWS.on("ready", () => {
        nextWS.setVolume(0);
        nextWS.play();

        fadeVolume(wavesurfer, 1, 0, fadeDur);
        fadeVolume(nextWS, 0, 1, fadeDur);

        setTimeout(() => {
            wavesurfer.destroy();
            wavesurfer = nextWS;
            currentIndex = nextIndex;
            setupEndWatcher();
        }, fadeDur * 1000);
    });

    nextWS.load(playlist[nextIndex].file);
}

/* -------------------------------
   DETECT END â†’ CROSSFADE
-------------------------------- */
function setupEndWatcher() {
    wavesurfer.on("audioprocess", () => {
        let remaining = wavesurfer.getDuration() - wavesurfer.getCurrentTime();
        let fadeDur = parseFloat(document.getElementById("crossfade").value);

        if (document.getElementById("autoNext").checked) {
            if (remaining <= fadeDur + 0.05) {
                wavesurfer.un("audioprocess");
                playNextWithCrossfade();
            }
        }
    });
}

wavesurfer.on("ready", setupEndWatcher);
</script>

</body>
</html>
